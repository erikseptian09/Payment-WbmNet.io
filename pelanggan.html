<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Form Pembayaran Pelanggan</title>
  <link rel="stylesheet" href="billing.css">
</head>
<body>
  <div class="container">
    <h2>Formulir Pembayaran</h2>

    <label for="rekening">Pilih Rekening Tujuan:</label>
    <select id="rekening">
      <option value="" disabled selected>-- Pilih Rekening Tujuan --</option>
      <option value="BCA - 6880777741 a.n WBM NET">BCA - 6880777741 a.n Asep Jaelani</option>
      <option value="BRI - 084701025669538 a.n WBM NET">BRI - 084701025669538 a.n Asep Jaelani</option>
      <option value="MANDIRI - 1560017886260 a.n WBM NET">MANDIRI - 1560017886260 a.n EUIS JUBAEDAH</option>
      <option value="DANA - 083895300118 a.n WBM NET">DANA - 083895300118 a.n ASEP JAELANI</option>
      <option value="QRIS - Scan QR Code">QRIS - Scan QR Code</option>
    </select>

    <textarea id="keterangan" placeholder="Contoh: Transfer via BRImo, atas nama..."></textarea>

    <label for="bukti">Upload Bukti Pembayaran:</label>
    <input type="file" id="bukti" accept="image/*,application/pdf" />

    <button onclick="kirimPembayaran()">Kirim Pembayaran</button>
    <p id="status" style="color: green;"></p>
  </div>

  <script src="config.js"></script>
  <script>
    const nohp = localStorage.getItem('nohp');
    if (!nohp) window.location.href = 'login_pelanggan.html';

    const db = firebase.database();

    // Ambil data pelanggan dari nohp
    db.ref('pelanggan').orderByChild('telepon').equalTo(nohp).once('value', snapshot => {
      if (snapshot.exists()) {
        const data = Object.values(snapshot.val())[0];
        document.getElementById('nama').value = data.nama;
        document.getElementById('paket').value = data.paket;
      } else {
        document.querySelector('.container').innerHTML = '<p>Data pelanggan tidak ditemukan.</p>';
      }
    });

    function kirimPembayaran() {
      const nama = document.getElementById('nama').value;
      const paket = document.getElementById('paket').value;
      const rekening = document.getElementById('rekening').value;
      const keterangan = document.getElementById('keterangan').value;
      const buktiFile = document.getElementById('bukti').files[0];

      if (!rekening) {
        document.getElementById('status').innerText = 'Pilih rekening tujuan terlebih dahulu.';
        return;
      }

      if (!keterangan || !buktiFile) {
        document.getElementById('status').innerText = 'Lengkapi keterangan dan upload bukti pembayaran.';
        return;
      }

      const storageRef = firebase.storage().ref('bukti/' + Date.now() + '_' + buktiFile.name);
      storageRef.put(buktiFile).then(snapshot => {
        snapshot.ref.getDownloadURL().then(url => {
          const data = {
            nama, paket, telepon: nohp,
            rekening, keterangan,
            bukti: url,
            status: 'Menunggu Konfirmasi',
            tanggal: new Date().toLocaleString('id-ID')
          };
          db.ref('konfirmasi').push(data);
          document.getElementById('status').innerText = '✅ Bukti pembayaran berhasil dikirim.';
        });
      }).catch(err => {
        document.getElementById('status').innerText = '❌ Gagal upload bukti.';
        console.error(err);
      });
    }
  </script>
</body>
</html>
